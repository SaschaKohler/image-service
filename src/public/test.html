<!doctype html>
<html lang="en" class="h-full bg-gray-50">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test Interface | HTML to Image Service</title>
    <link href="/css/output.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.3/ace.js"></script>
  </head>
  <!-- Navigation Component -->
  <!-- Navigation Component -->
  <nav class="bg-white shadow">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex h-16 justify-between">
        <div class="flex">
          <div class="flex flex-shrink-0 items-center">
            <svg
              class="h-8 w-8 text-blue-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
              />
            </svg>
            <span class="ml-2 text-xl font-bold text-gray-900">HTML to Image</span>
          </div>
          <div class="ml-6 flex items-center space-x-4">
            <a href="/" class="navlink">Home</a>
            <a href="/test.html" class="navlink">Test Interface</a>
            <a href="/gallery.html" class="navlink">Gallery</a>
            <a href="/doc.html" class="navlink">Docs</a>
          </div>
        </div>
        <div class="flex items-center">
          <a
            href="/auth.html"
            id="authButton"
            class="rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500"
          >
            Login
          </a>
        </div>
      </div>
    </div>
  </nav>

  <body class="h-full">
    <div
      id="authRequiredNotice"
      class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
        <h2 class="text-lg font-medium text-gray-900 mb-4">Authentication Required</h2>
        <p class="text-gray-500 mb-6">Please log in or register to use the test interface.</p>
        <div class="flex justify-end space-x-4">
          <a
            href="/auth.html?redirect=test"
            class="inline-flex justify-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2"
          >
            Go to Login
          </a>
        </div>
      </div>
    </div>
    <main class="py-10">
      <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="mb-8">
          <h1 class="text-2xl font-bold text-gray-900">Test Interface</h1>
          <p class="mt-1 text-sm text-gray-500">
            Use this interface to test the HTML to Image conversion with live preview.
          </p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <!-- Editor Section -->
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700">HTML Content</label>
              <div
                class="mt-1 rounded-md shadow-sm border border-gray-300"
                style="height: 300px"
                id="htmlEditor"
              ></div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">CSS Styles</label>
              <div
                class="mt-1 rounded-md shadow-sm border border-gray-300"
                style="height: 200px"
                id="cssEditor"
              ></div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Template Data (JSON)</label>
              <div
                class="mt-1 rounded-md shadow-sm border border-gray-300"
                style="height: 200px"
                id="templateDataEditor"
              ></div>
            </div>

            <div class="space-y-4 bg-white p-4 rounded-lg shadow-sm">
              <h3 class="font-medium text-gray-900">Image Settings</h3>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label for="viewportWidth" class="block text-sm font-medium text-gray-700">
                    Viewport Width
                  </label>
                  <div class="mt-1">
                    <input
                      type="number"
                      id="viewportWidth"
                      value="800"
                      min="100"
                      max="2400"
                      class="block w-full rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6"
                    />
                  </div>
                </div>

                <div>
                  <label for="viewportHeight" class="block text-sm font-medium text-gray-700">
                    Viewport Height
                  </label>
                  <div class="mt-1">
                    <input
                      type="number"
                      id="viewportHeight"
                      value="600"
                      min="100"
                      max="2400"
                      class="block w-full rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6"
                    />
                  </div>
                </div>

                <div>
                  <label for="deviceScale" class="block text-sm font-medium text-gray-700">
                    Device Scale
                  </label>
                  <div class="mt-1">
                    <select
                      id="deviceScale"
                      class="block w-full rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6"
                    >
                      <option value="1">1x</option>
                      <option value="2">2x</option>
                      <option value="3">3x</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label for="googleFonts" class="block text-sm font-medium text-gray-700">
                    Google Fonts (optional)
                  </label>
                  <div class="mt-1">
                    <input
                      type="text"
                      id="googleFonts"
                      placeholder="e.g., Roboto|Open+Sans"
                      class="block w-full rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6"
                    />
                  </div>
                  <p class="mt-1 text-xs text-gray-500">Separate multiple fonts with |</p>
                </div>

                <div>
                  <label for="renderDelay" class="block text-sm font-medium text-gray-700">
                    Render Delay (ms)
                  </label>
                  <div class="mt-1">
                    <input
                      type="number"
                      id="renderDelay"
                      value="0"
                      min="0"
                      max="5000"
                      class="block w-full rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6"
                    />
                  </div>
                  <p class="mt-1 text-xs text-gray-500">Wait before capture (for animations)</p>
                </div>
              </div>
            </div>

            <div class="flex items-center space-x-4">
              <button onclick="generateImage()" class="btn-primary">Generate Image</button>
              <button onclick="saveTemplate()" class="btn-secondary">Save as Template</button>
            </div>
          </div>

          <!-- Preview Section -->
          <div>
            <div class="mb-4">
              <h2 class="text-lg font-medium text-gray-900">Preview</h2>
              <p class="text-sm text-gray-500">Live preview of your generated image.</p>
            </div>

            <div class="bg-white rounded-lg shadow p-4">
              <div id="preview" class="min-h-[200px] border border-gray-200 rounded"></div>
            </div>

            <div id="response" class="mt-4 bg-gray-50 rounded-md p-4 text-sm text-gray-600 hidden">
              <!-- Response will be shown here -->
            </div>
          </div>
        </div>
      </div>
    </main>

    <style>
      .btn-primary {
        @apply rounded-md bg-blue-600 px-3.5 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600;
      }
      .btn-secondary {
        @apply rounded-md bg-white px-3.5 py-2.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50;
      }
    </style>

    <script>
      if (!localStorage.getItem('userEmail') || !localStorage.getItem('apiKey')) {
        document.getElementById('authRequiredNotice').classList.remove('hidden');
      }

      document.addEventListener('DOMContentLoaded', () => {
        const htmlEditor = ace.edit('htmlEditor');
        htmlEditor.setTheme('ace/theme/chrome');
        htmlEditor.session.setMode('ace/mode/html');
        htmlEditor.setValue(
          `<div class="p-8 max-w-md mx-auto bg-white rounded-xl shadow-lg space-y-4">
  <h1 class="text-2xl font-bold text-blue-600">{{title}}</h1>
  <div class="flex items-center space-x-4">
    <img src="{{avatarUrl}}" class="w-12 h-12 rounded-full" alt="Avatar">
    <div>
      <div class="text-xl font-medium text-black">{{name}}</div>
      <p class="text-gray-500">{{description}}</p>
    </div>
  </div>
  <div class="bg-gray-100 p-4 rounded">
    {{message}}
  </div>
</div>`,
          -1
        );

        const cssEditor = ace.edit('cssEditor');
        cssEditor.setTheme('ace/theme/chrome');
        cssEditor.session.setMode('ace/mode/css');
        cssEditor.setValue(`/* Additional CSS here */`, -1);

        const templateDataEditor = ace.edit('templateDataEditor');
        templateDataEditor.setTheme('ace/theme/chrome');
        templateDataEditor.session.setMode('ace/mode/json');
        templateDataEditor.setValue(
          `{
  "title": "Welcome!",
  "avatarUrl": "/api/placeholder/48/48",
  "name": "John Doe",
  "description": "Software Developer",
  "message": "This is a test message"
}`,
          -1
        );

        // Preview-Aktualisierung
        let previewTimeout;
        const updatePreview = () => {
          try {
            let templateData = {};
            try {
              const jsonContent = templateDataEditor.getValue().trim();
              if (jsonContent) {
                templateData = JSON.parse(jsonContent);
              }
            } catch (error) {
              console.warn('Invalid JSON, using empty object:', error);
            }

            const html = htmlEditor.getValue();
            const css = cssEditor.getValue();
            const isFullHtml =
              html.trim().toLowerCase().startsWith('<!doctype') ||
              html.trim().toLowerCase().startsWith('<html');

            let processedHtml;
            if (isFullHtml) {
              // Für vollständige HTML-Dokumente
              processedHtml = html.replace(/\{\{(\w+)\}\}/g, (match, key) => {
                return templateData[key] || match;
              });
            } else {
              // Für HTML-Fragmente - Wrapper mit einzigartigem Klassennamen
              processedHtml = `
        <div class="preview-content-wrapper">
          ${html.replace(/\{\{(\w+)\}\}/g, (match, key) => {
            return templateData[key] || match;
          })}
        </div>
      `;
            }

            // Isoliere CSS durch Scoping auf den Preview-Container
            const scopedCss = isFullHtml
              ? css
              : `
      .preview-content-wrapper {
        ${css}
      }
      .preview-content-wrapper body {
        margin: unset;
        padding: unset;
        display: unset;
        justify-content: unset;
        align-items: unset;
        min-height: unset;
      }
    `;
            const googleFonts = document
              .getElementById('googleFonts')
              .value.split(',')
              .map(font => font.trim())
              .filter(Boolean);

            const fontLinks =
              googleFonts.length > 0
                ? `<link href="https://fonts.googleapis.com/css2?family=${googleFonts.join('|').replace(/\s+/g, '+')}&display=swap" rel="stylesheet">`
                : '';

            const preview = document.getElementById('preview');
            // Erstelle einen isolierten Container für die Preview
            preview.innerHTML = `
  ${fontLinks}
      <style>
        #preview-container {
          width: 100%;
          min-height: 200px;
          overflow: auto;
        }
        ${scopedCss}
      </style>
      <div id="preview-container">
        ${processedHtml}
      </div>
    `;
          } catch (error) {
            console.error('Preview error:', error);
          }
        };

        // Live Preview Events
        [htmlEditor, cssEditor, templateDataEditor].forEach(editor => {
          editor.session.on('change', () => {
            clearTimeout(previewTimeout);
            previewTimeout = setTimeout(updatePreview, 500);
          });
        });

        // Initial Preview
        updatePreview();

        // Image Generation
        window.generateImage = async () => {
          const response = document.getElementById('response');
          response.innerHTML = `
    <div class="animate-pulse flex space-x-4 bg-gray-50 p-4 rounded-lg">
      <div class="flex-1 space-y-4 py-1">
        <div class="h-4 bg-gray-300 rounded w-3/4"></div>
        <div class="space-y-2">
          <div class="h-4 bg-gray-300 rounded"></div>
        </div>
      </div>
    </div>
  `;
          response.classList.remove('hidden');

          try {
            let templateData = {};
            try {
              const jsonContent = templateDataEditor.getValue().trim();
              if (jsonContent) {
                templateData = JSON.parse(jsonContent);
              }
            } catch (error) {
              console.warn('Invalid JSON, using empty object:', error);
            }

            // Format Google Fonts
            const googleFonts = document
              .getElementById('googleFonts')
              .value.split(',')
              .map(font => font.trim())
              .filter(Boolean)
              .join(',');

            const res = await fetch('/v1/image', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization:
                  'Basic ' +
                  btoa(localStorage.getItem('userEmail') + ':' + localStorage.getItem('apiKey')),
              },
              body: JSON.stringify({
                html: htmlEditor.getValue().trim(),
                css: cssEditor.getValue().trim(),
                template_data: templateData,
                viewport_width: parseInt(document.getElementById('viewportWidth').value) || 800,
                viewport_height: parseInt(document.getElementById('viewportHeight').value) || 600,
                device_scale: parseFloat(document.getElementById('deviceScale').value) || 1,
                google_fonts: googleFonts,
                ms_delay: parseInt(document.getElementById('renderDelay').value) || 0,
              }),
            });

            const data = await res.json();

            if (!res.ok) throw new Error(data.message || 'Failed to generate image');

            response.innerHTML = `
            <div class="space-y-4">
                <div class="bg-white p-4 rounded-lg shadow">
                    <img src="${data.url}" alt="Generated image" class="max-w-full rounded">
                </div>
                <div class="flex items-center gap-2">
                    <input type="text" 
                           value="${window.location.origin}${data.url}" 
                           class="flex-1 rounded-md border-0 py-1.5 text-gray-900 ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-blue-600 sm:text-sm sm:leading-6 px-2"
                           readonly 
                           onclick="this.select()">
                    <button onclick="copyImageUrl(this, '${window.location.origin}${data.url}')" 
                            class="rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">
                        Copy URL
                    </button>
                </div>
                <div class="text-sm text-gray-500">
                    <p>Size: ${document.getElementById('viewportWidth').value}x${document.getElementById('viewportHeight').value}</p>
                    <p>Scale: ${document.getElementById('deviceScale').value}x</p>
                </div>
            </div>
        `;
          } catch (error) {
            response.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded p-4">
                <p class="text-red-800">${error.message}</p>
            </div>
        `;
          }
        };

        // Save Template
        window.saveTemplate = async () => {
          const response = document.getElementById('response');
          response.innerHTML = 'Saving template...';
          response.classList.remove('hidden');

          try {
            let templateData;
            try {
              templateData = JSON.parse(templateDataEditor.getValue().trim());
            } catch (error) {
              throw new Error('Invalid template data JSON: ' + error.message);
            }

            const res = await fetch('/v1/template', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Authorization:
                  'Basic ' +
                  btoa(localStorage.getItem('userEmail') + ':' + localStorage.getItem('apiKey')),
              },
              body: JSON.stringify({
                html: htmlEditor.getValue().trim(),
                css: cssEditor.getValue().trim(),
                template_data: templateData,
                name: 'Test Template',
                description: 'Created from Test Interface',
              }),
            });

            const data = await res.json();

            if (!res.ok) throw new Error(data.message || 'Failed to save template');

            response.innerHTML = `
          <div class="bg-green-50 border border-green-200 rounded p-4">
            <p class="text-green-800">Template saved successfully!</p>
          </div>
        `;
          } catch (error) {
            response.innerHTML = `
          <div class="bg-red-50 border border-red-200 rounded p-4">
            <p class="text-red-800">${error.message}</p>
          </div>
        `;
          }
        };

        // URL Copy Funktion
        window.copyImageUrl = (button, url) => {
          navigator.clipboard.writeText(url).then(() => {
            const originalText = button.textContent;
            button.textContent = 'Copied!';
            button.classList.add('bg-green-50', 'text-green-700', 'ring-green-600/20');
            setTimeout(() => {
              button.textContent = originalText;
              button.classList.remove('bg-green-50', 'text-green-700', 'ring-green-600/20');
            }, 2000);
          });
        };
      });
    </script>
  </body>
</html>
